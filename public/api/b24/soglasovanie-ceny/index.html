<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π —Å–¥–µ–ª–∫–∏</title>
  <!-- Cache hard kill (helps against iframe sticky caches) -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{
      --bg:#0c1020;
      --panel:#111733;
      --panel-2:#161c3a;
      --ink:#e9f0ff;
      --ink-dim:#afbbd6;
      --accent:#6d4ee7;
      --accent-2:#8b6efe;
      --ok:#b5ffcf;
      --bad:#ff8a8a;
      --ring:#6f5bd6;
      --muted: #9aa7c7;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.03) inset;
      --radius:18px;
      --gap:40px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1100px 600px at 70% -50%, #1b2147 0%, transparent 60%) ,var(--bg);
      color:var(--ink);
      font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Segoe UI", "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px 20px 64px}
    .sticky{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(0deg, rgba(12,16,32,0) 0%, rgba(12,16,32,0.65) 25%, rgba(12,16,32,0.85) 100%);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      margin:-24px -20px 24px;
      padding:20px 28px 18px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    h1{
      margin:0;
      font-weight:800;
      letter-spacing:.3px;
      font-size:28px;
      display:flex; align-items:center; justify-content:space-between;
      gap:16px;
    }
    .btn{
      border:0; cursor:not-allowed;
      padding:16px 24px;
      min-width:360px;
      border-radius:18px;
      background:linear-gradient(160deg,var(--accent) 0%, var(--accent-2) 100%);
      color:#fff; font-weight:800; letter-spacing:.4px;
      box-shadow: var(--shadow);
      opacity:.55;
      transition:transform .08s ease, box-shadow .2s ease, opacity .2s ease;
      text-transform:uppercase;
    }
    .btn.ready{cursor:pointer; opacity:1}
    .btn.ready:hover{transform:translateY(-1px); box-shadow:0 14px 34px rgba(109,78,231,.33)}
    .panel{
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px 22px;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:var(--gap);
    }
    @media (max-width: 920px){ .grid{ grid-template-columns:1fr } .btn{min-width:260px} }
    .field{ display:flex; flex-direction:column; gap:10px; }
    label{
      color:var(--ink);
      font-weight:600; /* will tone down with .light */
      font-size:14px;
      letter-spacing:.2px;
    }
    label.light{ font-weight:500; color:var(--ink-dim); font-size:16px; }
    input[type="text"], input[type="number"], textarea{
      width:100%;
      border:1px solid rgba(149, 159, 195, .15);
      outline:none;
      border-radius:14px;
      padding:14px 16px;
      background:rgba(20,26,56,.7);
      color:var(--ink);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    textarea{ min-height:200px; resize:vertical }
    .muted{ color:var(--muted) }
    .status{
      padding:18px 20px; border-radius:16px;
      border:1px dashed rgba(255,255,255,.15);
      color:var(--ink); background:rgba(20,26,56,.45);
      margin-top:16px;
    }
    .status.error{ color:#ffdede; border-color:rgba(255,138,138,.45); background:rgba(138,20,20,.25) }
    .ok-card{
      margin-top:24px;
      text-align:center;
      padding:30px 24px 36px;
      background:linear-gradient(180deg, rgba(31,45,86,.65) 0%, rgba(18,30,64,.65) 100%);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow: var(--shadow);
    }
    .ok-card h2{
      margin:0 0 10px 0; font-size:40px; color:var(--ok); letter-spacing:.6px;
    }
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:10px 14px; border-radius: 14px;
      background: rgba(109,78,231,.14);
      color:#d8d2ff; font-weight:700; letter-spacing:.2px;
      border:1px solid rgba(109,78,231,.35);
    }
    .two-big{ display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); }
    @media (max-width: 920px){ .two-big{ grid-template-columns:1fr } }
    .help{ font-size:14px; color:var(--muted); }
    .invalid input, .invalid textarea{ border-color:#ff6b6b; box-shadow:0 0 0 3px rgba(255,107,107,.15) }
    .filled input, .filled textarea{ box-shadow: 0 0 0 3px rgba(109,78,231,.13) inset; }
    .caption{ font-size:13px; color:var(--muted); margin-top:4px }
  </style>
</head>
<body>
<div class="wrap">
  <div class="sticky">
    <h1>
      <span>!232–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π —Å–¥–µ–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ:</span>
      <button id="submit" class="btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –º¬≤ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</button>
    </h1>
  </div>

  <div id="diag" class="panel status">
    <div><strong>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</strong></div>
    <ul id="diagList" class="muted" style="margin:8px 0 0 18px"></ul>
  </div>

  <div id="status" class="status" style="margin-top:16px">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ø–æ—Ä—Ç–∞–ª—É...</div>

  <div id="formWrap" class="panel" style="margin-top:24px; display:none">
    <div class="grid" id="fieldsGrid"></div>
    <div class="two-big" style="margin-top:var(--gap)">
      <div class="field">
        <label for="UF_CRM_1757040827538" class="light">
          –û–ø–∏—à–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ –æ–±—ä–µ–∫—Ç–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä –∑–∞–µ—Ö–∞–ª.
          –ò–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–µ—Ç –≤ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–¥–µ–ª. –ï—Å–ª–∏ –Ω–∏ –∫–∞–∫–∏—Ö —Ä–∞–±–æ—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–∞–∫ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ
          <span class="caption">–ü—Ä–∏–º–µ—Ä: 1. –°—Ç–µ–Ω—ã –≤—ã—Ä–æ–≤–Ω—è—Ç—å, –∑–∞—à–ø–∞–∫–ª–µ–≤–∞—Ç—å - –ø–æ–∫—Ä–∞—Å—è—Ç —Å–∞–º–∏<br/>2. –ü–æ–ª –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–æ–¥ –ª–∞–º–∏–Ω–∞—Ç<br/>3. –û—Ç–∫–æ—Å—ã –≤—ã—Ä–æ–≤–Ω—è—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å<br/>4. –ü—Ä–æ–≤–µ—Å—Ç–∏ —ç–ª–µ–∫—Ç—Ä–∏–∫—É<br/>5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–≤–µ—Ä–∏<br/>6. –ü—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ –∫–æ—Ä–∏–¥–æ—Ä–Ω—É—é –≥—Ä—É–ø–ø—É<br/>–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä —Å–≤–æ–∏–º–∏ —Å–∏–ª–∞–º–∏ –ø–æ–ª–æ–∂–∏—Ç –ª–∞–º–∏–Ω–∞—Ç –∏ —É—Å—Ç—Ä–æ–∏—Ç –Ω–∞—Ç—è–∂–Ω–æ–π –ø–æ—Ç–æ–ª–æ–∫, –ø–æ–∫—Ä–∞—Å–∏—Ç—å —Å—Ç–µ–Ω—ã</span>
        </label>
        <textarea id="UF_CRM_1757040827538" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–¥–µ—Å—å..."></textarea>
      </div>
      <div class="field">
        <label for="UF_CRM_1757040956282" class="light">
          –û–ø–∏—à–∏—Ç–µ, —á—Ç–æ-—Ç–æ –µ—â–µ, —á—Ç–æ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è. –ù–∞–ø—Ä–∏–º–µ—Ä ‚Äî –∫–∞–∫ –¥–∞–≤–Ω–æ –ø—É—Å—Ç—É–µ—Ç –ø–æ–º–µ—â–µ–Ω–∏–µ, –∏–ª–∏
          —á—Ç–æ –≤—ã –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å, —á—Ç–æ —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞ —Ü–µ–Ω–∞ –≤—ã—Ä–∞—Å—Ç–µ—Ç... –¢—É—Ç –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª—é–±—É—é –≤–∞–∂–Ω—É—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é
          –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –ø–æ–ª—è—Ö —Å–¥–µ–ª–∫–∏
        </label>
        <textarea id="UF_CRM_1757040956282" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
      </div>
    </div>
  </div>

  <div id="done" class="ok-card" style="display:none">
    <div class="pill">–ì–æ—Ç–æ–≤–æ</div>
    <h2>–°–ø–∞—Å–∏–±–æ :) –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</h2>
    <div>–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –∑–∞—è–≤–∫—É! –ñ–µ–ª–∞—é –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–Ω—è üöÄ</div>
  </div>
</div>

<script>
(function(){
  const VERSION = "v24";
  const FIELDS = [
    {code:'UF_CRM_1737115114028', label:'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ –≤–∞–∂–Ω–æ –∫–ª–∏–µ–Ω—Ç—É?', type:'textarea', required:true},
    {code:'UF_CRM_1737115941816', label:'–ü–ª–æ—â–∞–¥—å –º¬≤', type:'number', required:true},
    {code:'UF_CRM_1737116070781', label:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ/–≤–∏–¥ –±–∏–∑–Ω–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞', type:'text', required:true},
    {code:'UF_CRM_1737116470642', label:'–°—Ç–æ–∏–º–æ—Å—Ç—å –º¬≤ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ', type:'number', required:true},
    {code:'UF_CRM_1755537385514', label:'–ì–æ—Ä–æ–¥ –∏ –∞–¥—Ä–µ—Å', type:'text', required:true},
    {code:'UF_CRM_1756910832606', label:'–ê—Ä–µ–Ω–¥–Ω—ã–µ –∫–∞–Ω–∏–∫—É–ª—ã (–µ—Å—Ç—å/–Ω–µ—Ç/—Å–∫–æ–ª—å–∫–æ)', type:'text', required:true},
    {code:'UF_CRM_1756969923586', label:'–û—Ç–æ–ø–ª–µ–Ω–∏–µ (–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–°–≤–µ—Ä—Ö—É/–ò–Ω–æ–µ)', type:'text', required:true},
    {code:'UF_CRM_1756969983186', label:'–ù–î–° (–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–°–≤–µ—Ä—Ö—É+–ø—Ä–æ—Ü–µ–Ω—Ç)', type:'text', required:true}
  ];

  // DOM helpers
  const $ = (s,p=document)=>p.querySelector(s);
  const diagList = $('#diagList');
  const statusEl = $('#status');
  const formWrap = $('#formWrap');
  const fieldsGrid = $('#fieldsGrid');
  const doneEl = $('#done');
  const submitBtn = $('#submit');

  function logDiag(text){
    const li = document.createElement('li'); li.textContent = text; diagList.appendChild(li);
  }
  function showStatus(text, type){
    statusEl.textContent = text;
    statusEl.className = 'status' + (type ? ' ' + type : '');
  }
  function markFilled(el){
    el.closest('.field')?.classList.remove('invalid');
    const val = (el.value||'').toString().trim();
    if(val.length) el.closest('.field')?.classList.add('filled'); else el.closest('.field')?.classList.remove('filled');
    computeButtonState();
  }
  function computeButtonState(){
    // enable if all required fields are non-empty
    const invalids = fieldsGrid.querySelectorAll('.field[data-required="1"] textarea, .field[data-required="1"] input');
    let allOk = true;
    invalids.forEach(inp => { if(!(inp.value||'').toString().trim().length){ allOk=false; } });
    if(allOk){ submitBtn.disabled=false; submitBtn.classList.add('ready'); submitBtn.style.cursor='pointer'; }
    else{ submitBtn.disabled=true; submitBtn.classList.remove('ready'); submitBtn.style.cursor='not-allowed'; }
  }

  // Diagnostics header
  logDiag('boot ' + VERSION);
  logDiag('path=' + location.pathname);
  logDiag('query=' + location.search);
  logDiag('typeof BX24=' + (typeof window.BX24));

  // Basic build grid
  for (const f of FIELDS){
    const wrap = document.createElement('div');
    wrap.className = 'field';
    wrap.dataset.code = f.code;
    wrap.dataset.required = f.required ? '1' : '0';
    const lab = document.createElement('label'); lab.textContent = f.label; lab.className = 'light';
    const ctrl = f.type === 'textarea' ? document.createElement('textarea') : document.createElement('input');
    if(f.type !== 'textarea'){ ctrl.type = f.type || 'text'; }
    ctrl.id = f.code;
    ctrl.addEventListener('input', ()=> markFilled(ctrl));
    wrap.appendChild(lab); wrap.appendChild(ctrl);
    fieldsGrid.appendChild(wrap);
  }

  // Get query params helper
  function qp(name){
    const url = new URL(location.href);
    return url.searchParams.get(name);
  }
  function parseIdFromReferrer(){
    try{
      const ref = document.referrer||'';
      const m = ref.match(/\/crm\/deal\/details\/(\d+)\//i);
      return m && m[1] ? m[1] : null;
    }catch(e){ return null; }
  }

  // Main BX24 integration
  let DEAL_ID = null;
  let initialData = {};

  async function detectDealId(){
    // priority: explicit query -> BX24.placement.info -> referrer
    const q = qp('id') || qp('deal_id') || qp('entityId') || qp('ID');
    if(q){ return q; }
    if(window.BX24 && BX24.placement && BX24.placement.info){
      try{
        const info = await new Promise(res=>BX24.placement.info(res));
        logDiag('placement=' + (info && info.placement));
        if(info && info.options){
          const o = info.options;
          const cid = o.ID || o.id || o.entityId;
          if(cid){ return cid; }
        }
      }catch(e){ /* ignore */}
    }
    const rid = parseIdFromReferrer();
    if(rid){ return rid; }
    return null;
  }

  function bx(method, params){
    return new Promise((resolve,reject)=>{
      try{
        BX24.callMethod(method, params, res => {
          if(res.error()){ reject({code:res.error(), desc:res.error_description()}); }
          else{ resolve(res.data()); }
        });
      }catch(e){ reject(e); }
    });
  }

  async function boot(){
    if(typeof window.BX24 === 'undefined'){
      showStatus('BX24 –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∏–¥–∂–µ—Ç –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–¥–µ–ª–∫–∏.', 'error');
      return;
    }
    showStatus('–û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Å–¥–µ–ª–∫–∏...');
    DEAL_ID = await detectDealId();
    if(!DEAL_ID){
      showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Å–¥–µ–ª–∫–∏. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∏–¥–∂–µ—Ç –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–¥–µ–ª–∫–∏.', 'error');
      return;
    }
    showStatus('–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—è —Å–¥–µ–ª–∫–∏ #' + DEAL_ID + '...');
    try{
      const deal = await bx('crm.deal.get', {id: DEAL_ID});
      const data = deal || {};
      // fill fields
      initialData = {};
      for(const f of FIELDS){
        const v = data[f.code] ?? '';
        initialData[f.code] = (v===null || typeof v === 'undefined') ? '' : (typeof v === 'string' ? v : Array.isArray(v) ? JSON.stringify(v) : String(v));
        const el = document.getElementById(f.code);
        if(el){ el.value = initialData[f.code]; markFilled(el); }
      }
      // long fields
      const long1 = 'UF_CRM_1757040827538', long2='UF_CRM_1757040956282';
      initialData[long1] = data[long1] || '';
      initialData[long2] = data[long2] || '';
      const l1 = document.getElementById(long1), l2 = document.getElementById(long2);
      if(l1){ l1.value = initialData[long1]; markFilled(l1); }
      if(l2){ l2.value = initialData[long2]; markFilled(l2); }

      formWrap.style.display='block';
      showStatus('–ì–æ—Ç–æ–≤–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.');

      submitBtn.addEventListener('click', onSubmit);
      computeButtonState();
    }catch(e){
      console.error(e);
      showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–∫–∏: ' + (e && (e.desc || e.code || e.message) || 'unknown'), 'error');
    }
  }

  function collectChanges(){
    const changes = {};
    for(const f of FIELDS){
      const el = document.getElementById(f.code);
      if(!el) continue;
      const cur = (el.value||'').toString();
      const was = (initialData[f.code]||'').toString();
      const required = !!f.required;
      if(required && !cur.trim().length){
        el.closest('.field')?.classList.add('invalid');
      }
      if(cur !== was){
        if(f.type === 'number'){
          const num = Number(cur.replace(',', '.'));
          changes[f.code] = isNaN(num) ? cur : num;
        }else{
          changes[f.code] = cur;
        }
      }
    }
    // long
    for(const code of ['UF_CRM_1757040827538','UF_CRM_1757040956282']){
      const el = document.getElementById(code);
      if(!el) continue;
      const cur = (el.value||'').toString();
      const was = (initialData[code]||'').toString();
      if(cur !== was) changes[code] = cur;
    }
    return changes;
  }

  async function onSubmit(){
    computeButtonState();
    if(submitBtn.disabled) return;
    const changes = collectChanges();
    try{
      submitBtn.disabled = true; submitBtn.classList.remove('ready'); submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
      if(Object.keys(changes).length){
        await bx('crm.deal.update', {id: DEAL_ID, fields: changes});
      }
      // Try to start BP #209 (ignore error if template not found)
      try{
        await bx('bizproc.workflow.start', {
          TEMPLATE_ID: 209,
          DOCUMENT_ID: ['crm', 'CCrmDocumentDeal', 'DEAL_' + DEAL_ID],
          PARAMETERS: {}
        });
      }catch(e){ console.warn('BP start skipped:', e); }
      doneEl.style.display='block';
      showStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –°–¥–µ–ª–∫–∞ #' + DEAL_ID + ' –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
      // scroll to bottom to show card
      setTimeout(()=> doneEl.scrollIntoView({behavior:'smooth', block:'center'}), 100);
    }catch(e){
      showStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (e && (e.desc || e.code || e.message) || 'unknown'), 'error');
    }finally{
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –º¬≤ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ';
    }
  }

  window.addEventListener('load', boot);
})();
</script>
</body>
</html>
