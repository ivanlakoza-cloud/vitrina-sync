(function(){const S=document.getElementById('status');function set(t,e){if(!S)return;S.textContent=t;S.className='status'+(e?' error':'')}function load(src,a){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;if(a)Object.entries(a).forEach(([k,v])=>s[k]=v);s.onload=()=>res(src);s.onerror=()=>rej(new Error('Failed to load '+src));document.head.appendChild(s)})}
async function ensure(){if(window.BX24&&typeof window.BX24.init==='function'){try{await new Promise(r=>window.BX24.init(r));window.BX24_READY=true;return true}catch(e){console.warn('BX24.init error:',e);return false}}try{await load('https://api.bitrix24.com/api/v1/');if(window.BX24&&typeof window.BX24.init==='function'){await new Promise(r=>window.BX24.init(r));window.BX24_READY=true;return true}}catch(e){console.warn('BX24 SDK load failed:',e)}return false}
(async function(){set('Диагностика: загружаем SDK Bitrix24…');const ok=await ensure();set(ok?'SDK Bitrix24 готов. Загружаем приложение…':'BX24 недоступен. Откройте виджет из карточки сделки или обновите страницу.',!ok);const bust=Date.now();try{await load('/b24/soglasovanie-ceny/app.js?v='+bust);if(ok)set('Готово')}catch(e){console.error(e);set('Не удалось загрузить приложение: '+e.message,true)}})()})();